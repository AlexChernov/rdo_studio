/*!
  \copyright (c) RDO-Team, 2011
  \file      rdodpt.cpp
  \authors   Барс Александр
  \authors   Урусов Андрей (rdo@rk9.bmstu.ru)
  \date      
  \brief     
  \indent    4T
*/

// ---------------------------------------------------------------------------- PCH
#include "simulator/compiler/mbuilder/pch.h"
// ----------------------------------------------------------------------- INCLUDES
// ----------------------------------------------------------------------- SYNOPSIS
#include "simulator/compiler/mbuilder/process.h"
#include "simulator/compiler/parser/rdoparser.h"
// --------------------------------------------------------------------------------

OPEN_MBUILDER_NAMESPACE

// --------------------------------------------------------------------------------
// -------------------- BlockForQueue
// --------------------------------------------------------------------------------
void BlockForQueue::createRes(RDOResType rtp, CREF(tstring) res_name)
{
	// Получили список всех ресурсов
	RDOResourceList rssList(rdoParse::RDOParser::s_parser());
	// Создадим ресурс
	RDOResource rss(rtp, res_name);
	// Добавим его в систему
	rssList.append<rdoParse::RDORSSResource>(rss);
}

rbool BlockForQueue::checkType(RDOResType rtp, CREF(rdoParse::RDOParserSrcInfo) info)
{
	UNUSED(info);

	// "длина_очереди"
	tstring rtp_param_name = rdoRuntime::RDOPROCQueue::getQueueParamName();
	// Тип найден, проверим его на наличие параметра "длина_очереди"
	if (!rtp.m_params[rtp_param_name].exist())
		rdoParse::RDOParser::s_parser()->error().error(rtp.src_info(), rdo::format(_T("У типа ресурса '%s' нет параметра integer '%s'"), rtp.name().c_str(), rtp_param_name.c_str()));

	CREF(RDOResType::Param) param = rtp.m_params[rtp_param_name];
	// Параметр Состояние есть, надо проверить, чтобы в нем были значения Свободен и Занят
	// Для начала проверим тип параметра
	if (param.typeID() != rdoRuntime::RDOType::t_int)
		rdoParse::RDOParser::s_parser()->error().error(param.src_info(), rdo::format(_T("У типа ресурса '%s' параметр '%s' не является параметром int"), rtp.name().c_str(), rtp_param_name.c_str()));

	return true;
}

RDOResType BlockForQueue::createType(CREF(tstring) rtp_name, CREF(rdoParse::RDOParserSrcInfo) info)
{
	// "длина_очереди"
	tstring rtp_param_name = rdoRuntime::RDOPROCQueue::getQueueParamName();
	// значение длины очереди по умолчанию
	rdoParse::LPRDOValue pDefaultValue = rdo::Factory<rdoParse::RDOValue>::create(
		rdo::explicit_value<ruint>(rdoRuntime::RDOPROCQueue::getDefaultValue()),
		info
	);
	ASSERT(pDefaultValue);
	// Получили список всех типов ресурсов
	RDOResTypeList rtpList(rdoParse::RDOParser::s_parser());
	// Создадим тип ресурса
	RDOResType rtp(rtp_name);
	// Создадим параметр типа integer
	RDOResType::Param param(rtp_param_name, rdo::Factory<rdoParse::RDOType__int>::create(), pDefaultValue);
	rtp.m_params.append(param);
	// Добавим тип ресурса
	if (!rtpList.append(rtp))
	{
		rdoParse::RDOParser::s_parser()->error().error(info, rdo::format(_T("Ошибка создания типа ресурса: %s"), rtp_name.c_str()));
	}
	else
	{
		rdoParse::LPRDORTPResType pResType = rdoParse::RDOParser::s_parser()->findRTPResType(rtp_name);
		ASSERT(pResType);
		pResType->setType(rdoParse::RDORTPResType::procRes);
	}
	return rtp;
}

// --------------------------------------------------------------------------------
// -------------------- BlockForSeize
// --------------------------------------------------------------------------------
rbool BlockForSeize::checkType(RDOResType rtp, CREF(rdoParse::RDOParserSrcInfo) info)
{
	// "Состояние"
	tstring rtp_param_name = rdoRuntime::RDOPROCBlockForSeize::getStateParamName();
	// "Свободен"
	tstring rtp_state_free = rdoRuntime::RDOPROCBlockForSeize::getStateEnumFree();
	// "Занят"
	tstring rtp_state_buzy = rdoRuntime::RDOPROCBlockForSeize::getStateEnumBuzy();
	// Тип найден, проверим его на наличие перечислимого параметра
	if (!rtp.m_params[rtp_param_name].exist())
		rdoParse::RDOParser::s_parser()->error().error(info, rdo::format(_T("У типа ресурса '%s' нет параметра перечислимого типа '%s'"), rtp.name().c_str(), rtp_param_name.c_str()));

	CREF(RDOResType::Param) param = rtp.m_params[rtp_param_name];
	// Параметр Состояние есть, надо проверить, чтобы в нем были значения Свободен и Занят
	// Для начала проверим тип параметра
	if (param.typeID() != rdoRuntime::RDOType::t_enum)
		rdoParse::RDOParser::s_parser()->error().error(param.src_info(), rdo::format(_T("У типа ресурса '%s' параметр '%s' не является параметром перечислимого типа"), rtp.name().c_str(), rtp_param_name.c_str()));

	// Теперь проверим сами значения
	if (!param.getEnum()->getEnums()->exist(rtp_state_free) || !param.getEnum()->getEnums()->exist(rtp_state_buzy))
		rdoParse::RDOParser::s_parser()->error().error(param.src_info(), rdo::format(_T("У типа ресурса '%s' перечислимый параметр '%s' должен иметь как минимум два обязательных значения: %s и %s"), rtp.name().c_str(), param.name().c_str(), rtp_state_free.c_str(), rtp_state_buzy.c_str()));

	return true;
}

void BlockForSeize::createRes(RDOResType rtp, CREF(tstring) res_name)
{
	// Получили список всех ресурсов
	RDOResourceList rssList(rdoParse::RDOParser::s_parser());
	// Создадим ресурс
	RDOResource rss(rtp, res_name);
	// Добавим его в систему
	rssList.append<rdoParse::RDORSSResource>(rss);
	//! \todo сделать ресурс процессным
}

void BlockForSeize::reobjectRes(RDOResType rtp, CREF(tstring) res_name)
{
	// Получили список всех ресурсов
	RDOResourceList rssList(rdoParse::RDOParser::s_parser());
	// Создадим ресурс
	RDOResource rssNew(rtp, res_name);
	// Добавим его в систему
	rssList.replace<rdoParse::RDORSSResource>(rssNew);
	//! \todo сделать ресурс процессным
}

RDOResType BlockForSeize::createType(CREF(tstring) rtp_name, CREF(rdoParse::RDOParserSrcInfo) info)
{
	// "Состояние"
	tstring rtp_param_name = rdoRuntime::RDOPROCBlockForSeize::getStateParamName();
	// "Свободен"
	tstring rtp_state_free = rdoRuntime::RDOPROCBlockForSeize::getStateEnumFree();
	rdoParse::LPRDOValue pDefaultValue = rdo::Factory<rdoParse::RDOValue>::create(
		rdo::explicit_value<tstring>(rtp_state_free),
		info
	);
	ASSERT(pDefaultValue);
	pDefaultValue->setSrcText(rtp_state_free);
	// "Занят"
	tstring rtp_state_buzy = rdoRuntime::RDOPROCBlockForSeize::getStateEnumBuzy();

	// Получили список всех типов ресурсов
	RDOResTypeList rtpList(rdoParse::RDOParser::s_parser());
	// Создадим тип ресурса
	RDOResType rtp(rtp_name);
	// Создадим параметр перечислимого типа - "Состояние"
	RDOResType::Param param(
		rtp_param_name,
		rdoRuntime::RDOEnumType::Enums(rtp_state_free)(rtp_state_buzy),
		pDefaultValue
	);
	rtp.m_params.append(param);
	// Добавим тип ресурса
	if (!rtpList.append(rtp))
	{
		rdoParse::RDOParser::s_parser()->error().error(info, rdo::format(_T("Ошибка создания типа ресурса: %s"), rtp_name.c_str()));
	}
	else
	{
		rdoParse::LPRDORTPResType pResType = rdoParse::RDOParser::s_parser()->findRTPResType(rtp_name);
		ASSERT(pResType);
		pResType->setType(rdoParse::RDORTPResType::procRes);
	}
	return rtp;
}

CLOSE_MBUILDER_NAMESPACE
